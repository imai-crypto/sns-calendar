<!DOCTYPE html>
<html class="light" lang="ja">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>投稿カレンダー - Excel連携</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <!-- SheetJS library for Excel file reading -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0dccf2",
                        "background-light": "#f5f8f8",
                        "background-dark": "#101f22",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .calendar-grid-line {
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
        }

        .calendar-container {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            /* 6週分が画面に収まるように固定高さ */
            grid-template-rows: repeat(6, minmax(0, 1fr));
            height: calc(100vh - 120px);
            /* さらに高さを広げる */
        }

        .day-cell {
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .day-cell-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .post-card {
            transition: all 0.15s;
        }

        .post-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .overflow-indicator {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, white 50%);
            padding-top: 12px;
            text-align: center;
        }

        .summary-bar {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
        }

        /* ホバーポップアップのスタイル */
        .hover-popup {
            position: fixed;
            z-index: 50;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 250px;
            max-height: 400px;
            overflow-y: auto;
            pointer-events: auto;
            /* 操作可能にする */
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-[#111718] antialiased">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar Navigation -->
        <aside
            class="w-64 border-r border-gray-200 bg-white dark:bg-background-dark dark:border-gray-800 flex flex-col">
            <div class="p-6 flex items-center gap-3">
                <div class="size-10 bg-primary rounded-lg flex items-center justify-center text-white">
                    <span class="material-symbols-outlined">analytics</span>
                </div>
                <div>
                    <h1 class="text-base font-bold leading-tight">SNS Analytics</h1>
                    <p class="text-xs text-[#60838a]">Calendar System</p>
                </div>
            </div>
            <nav class="flex-1 px-4 space-y-1">
                <a class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-500 hover:bg-gray-50"
                    href="dashboard.html">
                    <span class="material-symbols-outlined">dashboard</span>
                    Dashboard
                </a>
                <a class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg bg-primary/10 text-primary"
                    href="calendar-upload.html">
                    <span class="material-symbols-outlined"
                        style="font-variation-settings: 'FILL' 1;">calendar_today</span>
                    Content Calendar
                </a>
                <a class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-500 hover:bg-gray-50"
                    href="analytics.html">
                    <span class="material-symbols-outlined">bar_chart</span>
                    Analytics
                </a>
                <a class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-500 hover:bg-gray-50"
                    href="reports.html">
                    <span class="material-symbols-outlined">settings</span>
                    Settings
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Navigation Bar -->
            <header
                class="h-16 bg-white dark:bg-background-dark border-b border-gray-200 dark:border-gray-800 flex items-center justify-between px-8">
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-2">
                        <button onclick="changeMonth(-1)" class="p-1 hover:bg-gray-100 rounded-lg">
                            <span class="material-symbols-outlined text-gray-600">chevron_left</span>
                        </button>
                        <h2 id="currentMonth" class="text-lg font-bold">2024年1月</h2>
                        <button onclick="changeMonth(1)" class="p-1 hover:bg-gray-100 rounded-lg">
                            <span class="material-symbols-outlined text-gray-600">chevron_right</span>
                        </button>
                    </div>
                    <button onclick="goToToday()"
                        class="px-4 py-1.5 border border-gray-200 rounded-lg text-sm font-medium hover:bg-gray-50">今月</button>
                    <!-- 月間サマリー -->
                    <div id="monthlySummary" class="flex items-center gap-3 ml-4 pl-4 border-l border-gray-300 h-8">
                        <!-- ここにサマリーが動的に挿入されます -->
                    </div>
                </div>
                <!-- Upload & Export Buttons -->
                <div class="flex items-center gap-3">
                    <label for="excelFile"
                        class="flex items-center gap-2 cursor-pointer bg-primary text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-primary/90 transition-all">
                        <span class="material-symbols-outlined text-sm">upload_file</span>
                        <span>Excelアップロード</span>
                    </label>
                    <input type="file" id="excelFile" accept=".xlsx,.xlsm,.xls" class="hidden"
                        onchange="handleFileUpload(event)" />
                    <button onclick="copyCalendarToClipboard()"
                        class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-green-700 transition-all">
                        <span class="material-symbols-outlined text-sm">content_copy</span>
                        <span>コピー</span>
                    </button>
                    <button onclick="downloadCalendarCSV()"
                        class="flex items-center gap-2 bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-gray-800 transition-all">
                        <span class="material-symbols-outlined text-sm">download</span>
                        <span>CSV</span>
                    </button>
                    <div id="fileStatus" class="text-sm text-gray-500"></div>
                </div>
            </header>

            <!-- Filter Chips -->
            <div
                class="bg-white dark:bg-background-dark border-b border-gray-200 dark:border-gray-800 px-8 py-3 flex items-center gap-6 overflow-x-auto">
                <!-- 媒体フィルター -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500">媒体:</span>
                    <div class="flex gap-2">
                        <button onclick="togglePlatform('all')" id="btn-all"
                            class="filter-btn flex h-7 shrink-0 items-center justify-center gap-x-2 rounded-full border border-gray-200 bg-white px-3 hover:border-primary transition-all">
                            <p class="text-xs font-bold leading-normal">すべて</p>
                        </button>
                        <button onclick="togglePlatform('TikTok')" id="btn-tiktok" data-platform="TikTok"
                            class="filter-btn flex h-7 shrink-0 items-center justify-center gap-x-2 rounded-full border border-gray-200 bg-white px-3 hover:border-primary transition-all">
                            <p class="text-xs font-medium leading-normal">TikTok</p>
                        </button>
                        <button onclick="togglePlatform('IGリール')" id="btn-ig-reel" data-platform="IGリール"
                            class="filter-btn flex h-7 shrink-0 items-center justify-center gap-x-2 rounded-full border border-gray-200 bg-white px-3 hover:border-primary transition-all">
                            <p class="text-xs font-medium leading-normal">IGリール</p>
                        </button>
                        <button onclick="togglePlatform('IGフィード')" id="btn-ig-feed" data-platform="IGフィード"
                            class="filter-btn flex h-7 shrink-0 items-center justify-center gap-x-2 rounded-full border border-gray-200 bg-white px-3 hover:border-primary transition-all">
                            <p class="text-xs font-medium leading-normal">IGフィード</p>
                        </button>
                        <button onclick="togglePlatform('IGストーリー')" id="btn-ig-story" data-platform="IGストーリー"
                            class="filter-btn flex h-7 shrink-0 items-center justify-center gap-x-2 rounded-full border border-gray-200 bg-white px-3 hover:border-primary transition-all">
                            <p class="text-xs font-medium leading-normal">IGストーリー</p>
                        </button>
                    </div>
                </div>
                <!-- 作品名フィルター -->
                <div class="flex items-center gap-2 border-l border-gray-200 pl-6">
                    <span class="text-xs font-medium text-gray-500">作品名:</span>
                    <select id="workNameFilter" onchange="filterWorkName(this.value)"
                        class="h-7 px-3 text-xs border border-gray-200 rounded-full bg-white focus:border-primary focus:ring-1 focus:ring-primary cursor-pointer">
                        <option value="all">すべて</option>
                    </select>
                </div>
            </div>

            <!-- Calendar Container -->
            <div class="flex-1 overflow-auto bg-gray-50 dark:bg-background-dark/50">
                <!-- Day Labels -->
                <div
                    class="grid grid-cols-7 border-b border-gray-200 dark:border-gray-800 sticky top-0 bg-white dark:bg-background-dark z-10">
                    <div class="py-2 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">日</div>
                    <div class="py-2 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">月</div>
                    <div class="py-2 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">火</div>
                    <div class="py-2 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">水</div>
                    <div class="py-2 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">木</div>
                    <div class="py-2 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">金</div>
                    <div class="py-2 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">土</div>
                </div>
                <!-- Calendar Grid -->
                <div id="calendarGrid" class="calendar-container bg-white dark:bg-background-dark">
                    <!-- Days will be generated here by JavaScript -->
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentDate = new Date();
        let calendarData = [];
        // 複数選択フィルタに変更
        const allPlatformList = ['TikTok', 'IGリール', 'IGフィード', 'IGストーリー'];
        let selectedPlatforms = new Set(allPlatformList);
        let currentWorkNameFilter = 'all';
        // 媒体の優先順位（ソート用）統一: TT -> IGR -> IGF -> IGS
        const PLATFORM_PRIORITY = { 'TikTok': 1, 'IGリール': 2, 'IGフィード': 3, 'IGストーリー': 4 };

        // ステータスの色マッピング
        const statusColors = {
            '制作予定': { bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-300' },
            '制作中': { bg: 'bg-yellow-100', text: 'text-yellow-700', border: 'border-yellow-300' },
            '投稿済み': { bg: 'bg-green-100', text: 'text-green-700', border: 'border-green-300' },
            '予約完了': { bg: 'bg-primary/10', text: 'text-primary', border: 'border-primary/30' },
            'default': { bg: 'bg-gray-100', text: 'text-gray-700', border: 'border-gray-300' }
        };

        // SNSアイコンマッピング
        const platformIcons = {
            'IGリール': 'movie',
            'IGストーリー': 'auto_stories',
            'IGフィード': 'photo_camera',
            'TikTok': 'music_video',
            'default': 'send'
        };

        // フィルター操作（複数選択対応）
        function togglePlatform(platform) {
            if (platform === 'all') {
                // すべて選択
                allPlatformList.forEach(p => selectedPlatforms.add(p));
            } else {
                if (selectedPlatforms.has(platform)) {
                    selectedPlatforms.delete(platform);
                } else {
                    selectedPlatforms.add(platform);
                }

                // 何も選択されていない状態を回避するか？ 
                // 現在はゼロ件表示を許容する動作
            }

            updateFilterButtons();
            renderCalendar();
        }

        function updateFilterButtons() {
            // 'all' ボタン
            const btnAll = document.getElementById('btn-all');
            const isAllSelected = allPlatformList.every(p => selectedPlatforms.has(p));

            setButtonActive(btnAll, isAllSelected);

            // 個別ボタン
            allPlatformList.forEach(p => {
                let btnId = '';
                if (p === 'IGリール') btnId = 'btn-ig-reel';
                if (p === 'IGストーリー') btnId = 'btn-ig-story';
                if (p === 'IGフィード') btnId = 'btn-ig-feed';
                if (p === 'TikTok') btnId = 'btn-tiktok';

                const btn = document.getElementById(btnId);
                if (btn) setButtonActive(btn, selectedPlatforms.has(p));
            });
        }

        function setButtonActive(btn, isActive) {
            const activeClasses = ['border-primary', 'bg-primary/5', 'text-primary'];
            const inactiveClasses = ['border-gray-200', 'bg-white', 'text-gray-600'];

            // テキスト要素（pタグ）を取得
            const textElem = btn.querySelector('p');

            if (isActive) {
                btn.classList.add(...activeClasses);
                btn.classList.remove(...inactiveClasses);
                if (textElem) {
                    textElem.classList.add('text-primary');
                    textElem.classList.remove('text-gray-600');
                }
            } else {
                btn.classList.remove(...activeClasses);
                btn.classList.add(...inactiveClasses);
                if (textElem) {
                    textElem.classList.remove('text-primary');
                    textElem.classList.add('text-gray-600');
                }
            }
        }

        // 作品名フィルター
        function filterWorkName(name) {
            currentWorkNameFilter = name;
            renderCalendar();
        }




        // Excelファイル読み込み
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileStatus = document.getElementById('fileStatus');
            fileStatus.textContent = '読み込み中...';
            fileStatus.className = 'text-sm text-blue-500';

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // 「全体カレンダー」シートを読み込み
                    const sheetName = '全体カレンダー';
                    if (!workbook.SheetNames.includes(sheetName)) {
                        alert(`シート「${sheetName}」が見つかりません。\n利用可能なシート: ${workbook.SheetNames.join(', ')}`);
                        fileStatus.textContent = 'エラー: シートが見つかりません';
                        fileStatus.className = 'text-sm text-red-500';
                        return;
                    }

                    const worksheet = workbook.Sheets[sheetName];

                    // シートを2次元配列として読み込み（ヘッダー行を自動検出するため）
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });



                    // ヘッダー行を検出（「日程」列を含む行を探す）
                    let headerRowIndex = -1;
                    const targetColumns = ['日程', '投稿プラットフォーム', '投稿名', 'ブランド'];

                    for (let i = 0; i < Math.min(rawData.length, 20); i++) {
                        const row = rawData[i];
                        if (row && Array.isArray(row)) {
                            const rowStr = row.join(',').toLowerCase();
                            if (rowStr.includes('日程') || rowStr.includes('投稿プラットフォーム')) {
                                headerRowIndex = i;

                                break;
                            }
                        }
                    }

                    if (headerRowIndex === -1) {
                        alert('ヘッダー行が見つかりません。\n「日程」または「投稿プラットフォーム」列を含む行が必要です。\n\n最初の5行の内容:\n' + rawData.slice(0, 5).map((r, i) => `行${i + 1}: ${r.slice(0, 5).join(', ')}`).join('\n'));
                        fileStatus.textContent = 'エラー: ヘッダー行が見つかりません';
                        fileStatus.className = 'text-sm text-red-500';
                        return;
                    }

                    // ヘッダー行からカラム名を取得
                    const headers = rawData[headerRowIndex];


                    // データ行を取得（ヘッダー行の次から）
                    const dataRows = rawData.slice(headerRowIndex + 1);

                    // データをオブジェクト配列に変換
                    const jsonData = dataRows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            if (header && row[index] !== undefined) {
                                obj[header] = row[index];
                            }
                        });
                        return obj;
                    }).filter(obj => Object.keys(obj).length > 0);




                    // データを変換
                    calendarData = processExcelData(jsonData);

                    fileStatus.textContent = `${calendarData.length}件のデータを読み込みました`;
                    fileStatus.className = calendarData.length > 0 ? 'text-sm text-green-500' : 'text-sm text-orange-500';

                    if (calendarData.length === 0 && jsonData.length > 0) {
                        alert(`データは読み込まれましたが、有効な日程データが0件です。\n\n読み込まれた列名: ${Object.keys(jsonData[0]).join(', ')}\n\n日程列の値を確認してください。`);
                    }

                    // 作品名ドロップダウンを更新
                    updateWorkNameFilter();

                    // カレンダーを再描画
                    renderCalendar();

                    // データを永続化保存
                    saveCalendarData(calendarData);

                } catch (error) {
                    console.error('Excel読み込みエラー:', error);
                    alert('Excelファイルの読み込みに失敗しました。\n' + error.message);
                    fileStatus.textContent = 'エラー: 読み込み失敗';
                    fileStatus.className = 'text-sm text-red-500';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Excelデータを処理
        function processExcelData(jsonData) {
            // 対象プラットフォームのリスト
            const allowedPlatforms = ['IGリール', 'IGストーリー', 'IGフィード', 'TikTok'];

            return jsonData.map(row => {
                // 日付の処理（ユーザーのExcel列名「日程」に対応）
                let postDate = null;
                const dateField = row['日程'] || row['投稿日'] || row['日付'] || row['Date'] || row['投稿予定日'];

                if (dateField) {
                    if (typeof dateField === 'number') {
                        // Excelのシリアル値の場合
                        postDate = XLSX.SSF.parse_date_code(dateField);
                        postDate = new Date(postDate.y, postDate.m - 1, postDate.d);
                    } else {
                        postDate = new Date(dateField);
                    }
                }

                // 投稿プラットフォームをそのまま取得
                let platform = row['投稿プラットフォーム'] || row['SNS'] || row['媒体'] || row['Platform'] || '';

                // プラットフォーム名の正規化（表記揺れ対応）
                const platformLower = platform.toLowerCase();
                if (platformLower.includes('リール') || platformLower.includes('reel')) {
                    platform = 'IGリール';
                } else if (platformLower.includes('ストーリー') || platformLower.includes('story') || platformLower.includes('stories')) {
                    platform = 'IGストーリー';
                } else if (platformLower.includes('フィード') || platformLower.includes('feed')) {
                    platform = 'IGフィード';
                } else if (platformLower.includes('tiktok')) {
                    platform = 'TikTok';
                }

                // 時間の処理（Excelシリアル値を時刻文字列に変換）
                let timeValue = row['時間'] || '';
                if (typeof timeValue === 'number') {
                    // Excelのシリアル値（0.5 = 12:00）を時刻に変換
                    const totalMinutes = Math.round(timeValue * 24 * 60);
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    timeValue = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                }

                return {
                    date: postDate,
                    title: row['投稿名'] || row['タイトル'] || row['Title'] || '',
                    workName: row['作品名'] || '',
                    status: row['ステータス'] || row['Status'] || '投稿予定',
                    platform: platform,
                    brand: row['ブランド'] || '',
                    time: timeValue,
                    description: row['内容／備考'] || row['詳細'] || row['説明'] || row['Description'] || '',
                    specialDay: row['注意日／記念日'] || '',
                    thumbnail: row['サムネイル'] || row['Thumbnail'] || ''
                };
            }).filter(item => {
                // 日付が有効で、対象プラットフォームのみをフィルタリング
                const hasValidDate = item.date && !isNaN(item.date.getTime());
                const isAllowedPlatform = allowedPlatforms.includes(item.platform);
                return hasValidDate && isAllowedPlatform;
            });
        }

        // 日本の祝日判定 (2024-2026対応、簡易版)
        function getHolidayName(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dayOfWeek = date.getDay();

            // 春分・秋分の日の簡易計算 (2000-2030年まで有効な近似式)
            const vernalEquinoxDay = Math.floor(20.8431 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
            const autumnalEquinoxDay = Math.floor(23.2488 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));

            // 固定祝日
            if (month === 1 && day === 1) return '元日';
            if (month === 2 && day === 11) return '建国記念の日';
            if (month === 2 && day === 23) return '天皇誕生日';
            if (month === 3 && day === vernalEquinoxDay) return '春分の日';
            if (month === 4 && day === 29) return '昭和の日';
            if (month === 5 && day === 3) return '憲法記念日';
            if (month === 5 && day === 4) return 'みどりの日';
            if (month === 5 && day === 5) return 'こどもの日';
            if (month === 8 && day === 11) return '山の日';
            if (month === 9 && day === autumnalEquinoxDay) return '秋分の日';
            if (month === 11 && day === 3) return '文化の日';
            if (month === 11 && day === 23) return '勤労感謝の日';

            // ハッピーマンデー (成人の日: 1月第2月曜, 海の日: 7月第3月曜, 敬老の日: 9月第3月曜, スポーツの日: 10月第2月曜)
            function isNthMonday(n, targetMonth) {
                if (month !== targetMonth || dayOfWeek !== 1) return false;
                // n週目かどうかの計算: (day - 1) / 7 の商が n-1 であれば n週目
                return Math.floor((day - 1) / 7) === (n - 1);
            }

            if (isNthMonday(2, 1)) return '成人の日';
            if (isNthMonday(3, 7)) return '海の日';
            if (isNthMonday(3, 9)) return '敬老の日';
            if (isNthMonday(2, 10)) return 'スポーツの日';

            // 振替休日判定 (日曜と重なった場合の翌日)
            // 簡易的に「昨日が祝日で日曜だった場合」などをチェックするのは再帰が必要で複雑になるため、
            // カレンダー描画ループ内で前日の状態を持つか、主要な振替休日をハードコードするか。
            // ここでは主要な祝日が日曜の場合の翌日を判定する簡易ロジックを入れる。

            // 昨日の日付
            const yesterday = new Date(date);
            yesterday.setDate(day - 1);
            // 昨日が日曜かつ祝日なら今日は振替休日
            if (yesterday.getDay() === 0) {
                const yesterdayName = getHolidayName(yesterday);
                if (yesterdayName && yesterdayName !== '振替休日') return '振替休日';
            }

            // 5/6振替休日の特例 (5/3, 5/4, 5/5のいずれかが日曜なら振替)
            if (month === 5 && day === 6) {
                if (new Date(year, 4, 3).getDay() === 0 ||
                    new Date(year, 4, 4).getDay() === 0 ||
                    new Date(year, 4, 5).getDay() === 0) {
                    return '振替休日';
                }
            }

            return null;
        }

        // カレンダー描画
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            document.getElementById('currentMonth').textContent = `${year}年${month + 1}月`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // 月間サマリー集計用
            const monthlyCounts = {
                'TikTok': 0, 'IGリール': 0, 'IGフィード': 0, 'IGストーリー': 0,
                'Total': 0, 'Weekday': 0, 'Holiday': 0
            };

            // 前月の日付
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                const date = new Date(year, month - 1, day);
                grid.appendChild(createDayCell(day, null, true, date));
            }

            // 当月の日付
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDay = new Date(year, month, day);
                const posts = getPostsForDate(currentDay);

                // 集計
                if (posts.length > 0) {
                    const count = posts.length;
                    monthlyCounts['Total'] += count;

                    // 平日・休日判定
                    const dw = currentDay.getDay();
                    if (dw === 0 || dw === 6 || getHolidayName(currentDay)) {
                        monthlyCounts['Holiday'] += count;
                    } else {
                        monthlyCounts['Weekday'] += count;
                    }

                    posts.forEach(post => {
                        if (monthlyCounts[post.platform] !== undefined) {
                            monthlyCounts[post.platform]++;
                        }
                    });
                }

                grid.appendChild(createDayCell(day, posts, false, currentDay));
            }

            // 次月の日付
            const totalCells = Math.ceil((startDay + daysInMonth) / 7) * 7;
            const remainingCells = totalCells - (startDay + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                const date = new Date(year, month + 1, day);
                grid.appendChild(createDayCell(day, null, true, date));
            }

            // サマリー表示の更新
            updateMonthlySummary(monthlyCounts);
        }

        // 月間サマリーの表示更新
        function updateMonthlySummary(counts) {
            const summaryContainer = document.getElementById('monthlySummary');
            if (!summaryContainer) return;

            summaryContainer.innerHTML = '';

            // 合計、内訳、各媒体
            const groups = [
                {
                    items: [
                        { label: 'Total', value: counts['Total'], color: 'bg-indigo-600 text-white' }
                    ]
                },
                {
                    items: [
                        { label: '平日', value: counts['Weekday'], color: 'bg-gray-100 text-gray-700' },
                        { label: '土日祝', value: counts['Holiday'], color: 'bg-red-50 text-red-600' }
                    ],
                    separator: true
                },
                {
                    items: [
                        { label: 'TT', value: counts['TikTok'], color: 'bg-gray-800 text-white' },
                        { label: 'IGR', value: counts['IGリール'], color: 'bg-pink-100 text-pink-600' },
                        { label: 'IGF', value: counts['IGフィード'], color: 'bg-pink-100 text-pink-600' },
                        { label: 'IGS', value: counts['IGストーリー'], color: 'bg-pink-100 text-pink-600' }
                    ]
                }
            ];

            groups.forEach((group, index) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'flex items-center gap-2';
                if (group.separator) groupDiv.classList.add('mobile-hidden', 'border-l', 'border-gray-200', 'pl-3', 'ml-1');

                group.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-1';
                    div.innerHTML = `<span class="text-xs font-bold text-gray-500">${item.label}:</span> <span class="text-xs font-bold px-2 py-0.5 rounded ${item.color}">${item.value}</span>`;
                    groupDiv.appendChild(div);
                });

                summaryContainer.appendChild(groupDiv);
            });
        }

        // 指定日の投稿を取得
        function getPostsForDate(date) {
            return calendarData.filter(post => {
                if (!post.date) return false;

                // 複数選択フィルターの適用
                if (!selectedPlatforms.has(post.platform)) return false;

                if (currentWorkNameFilter !== 'all' && post.workName !== currentWorkNameFilter) return false;
                return post.date.getFullYear() === date.getFullYear() &&
                    post.date.getMonth() === date.getMonth() &&
                    post.date.getDate() === date.getDate();
            });
        }

        // 日付セルを作成
        function createDayCell(day, posts, isOtherMonth, dateObj) {
            const cell = document.createElement('div');

            let bgClass = '';
            let textClass = '';
            let holidayName = '';

            if (dateObj) {
                const dayOfWeek = dateObj.getDay();
                holidayName = getHolidayName(dateObj);

                if (dayOfWeek === 0 || holidayName) { // 日曜または祝日
                    bgClass = isOtherMonth ? 'bg-red-50/20' : 'bg-red-50/50';
                    textClass = 'text-red-500';
                } else if (dayOfWeek === 6) { // 土曜
                    bgClass = isOtherMonth ? 'bg-blue-50/20' : 'bg-blue-50/50';
                    textClass = 'text-blue-500';
                }
            }

            cell.className = `calendar-grid-line day-cell p-1 hover:bg-gray-50/80 transition-colors ${isOtherMonth ? 'opacity-40' : ''} ${bgClass}`;

            // ヘッダー部分（日付＋祝日名＋サマリー）
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex items-center justify-between mb-1';

            const dayInfo = document.createElement('div');
            dayInfo.className = 'flex items-center gap-1';

            const dayNumber = document.createElement('span');
            dayNumber.className = `text-xs font-bold ${textClass}`;
            dayNumber.textContent = day;
            dayInfo.appendChild(dayNumber);

            if (holidayName) {
                const holidaySpan = document.createElement('span');
                holidaySpan.className = 'text-[8px] text-red-500 font-medium truncate max-w-[60px] hidden sm:inline';
                holidaySpan.textContent = holidayName;
                dayInfo.appendChild(holidaySpan);
            }

            headerDiv.appendChild(dayInfo);

            // 媒体別サマリーを追加
            if (posts && posts.length > 0) {
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'summary-bar';

                // 媒体別にカウント
                const platformCounts = {};
                posts.forEach(post => {
                    platformCounts[post.platform] = (platformCounts[post.platform] || 0) + 1;
                });

                // 合計バッジ
                const totalBadge = document.createElement('span');
                totalBadge.className = 'text-[8px] px-1 rounded font-bold bg-indigo-50 text-indigo-600 mr-0.5 border border-indigo-100';
                totalBadge.textContent = `計${posts.length}`;
                summaryDiv.appendChild(totalBadge);

                // 表示順序と略語を定義（TT, IGR, IGF, IGS）
                const platformOrder = [
                    { key: 'TikTok', abbr: 'TT', isIG: false },
                    { key: 'IGリール', abbr: 'IGR', isIG: true },
                    { key: 'IGフィード', abbr: 'IGF', isIG: true },
                    { key: 'IGストーリー', abbr: 'IGS', isIG: true }
                ];

                platformOrder.forEach(({ key, abbr, isIG }) => {
                    const count = platformCounts[key];
                    if (count) {
                        const badge = document.createElement('span');
                        badge.className = `text-[8px] px-1 rounded font-bold ${isIG ? 'bg-pink-100 text-pink-600' : 'bg-gray-700 text-white'}`;
                        badge.textContent = `${abbr}${count}`;
                        summaryDiv.appendChild(badge);
                    }
                });

                headerDiv.appendChild(summaryDiv);
            }

            cell.appendChild(headerDiv);

            // 投稿カード部分（オーバーフロー対応）
            if (posts && posts.length > 0) {
                const groupedPosts = groupPostsByWorkName(posts);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'day-cell-content';

                const postsContainer = document.createElement('div');
                postsContainer.className = 'space-y-px'; // 間隔をさらに詰める
                postsContainer.id = `posts-${day}-${Math.random().toString(36).substr(2, 9)}`;

                // 最大表示件数（高さを考慮して2件に変更）
                // 画面高さが非常に小さい場合は1件にするなどのロジックも検討可能だが、基本2件とする
                const maxVisible = 2;
                const visibleGroups = groupedPosts.slice(0, maxVisible);
                const hiddenGroups = groupedPosts.slice(maxVisible);
                const hiddenCount = hiddenGroups.length;

                visibleGroups.forEach(group => {
                    const postCard = createGroupedPostCard(group);
                    postsContainer.appendChild(postCard);
                });

                contentDiv.appendChild(postsContainer);

                // オーバーフロー表示（ホバー＆クリック対応）
                if (hiddenCount > 0) {
                    const overflowDiv = document.createElement('div');
                    overflowDiv.className = 'overflow-indicator cursor-pointer';

                    const overflowSpan = document.createElement('span');
                    overflowSpan.className = 'text-[9px] text-blue-600 bg-blue-50 px-2 py-0.5 rounded hover:bg-blue-100 transition-colors';
                    overflowSpan.textContent = `+${hiddenCount}件`;

                    // ホバーイベント：ポップアップ表示
                    overflowSpan.addEventListener('mouseenter', function (e) {
                        if (window.popupHideTimeout) clearTimeout(window.popupHideTimeout);

                        const popup = document.getElementById('hoverPopup');
                        popup.innerHTML = ''; // クリア

                        hiddenGroups.forEach(group => {
                            const postCard = createGroupedPostCard(group);
                            popup.appendChild(postCard);
                        });

                        // 位置調整
                        const rect = e.target.getBoundingClientRect();
                        const windowHeight = window.innerHeight;
                        const popupHeight = popup.offsetHeight || (hiddenGroups.length * 60); // 推定高さ

                        // 基本は下方向に表示、画面下にはみ出る場合は上方向に表示
                        let top = rect.bottom + 5;
                        if (top + popupHeight > windowHeight - 20) {
                            top = rect.top - popupHeight - 5;
                        }

                        popup.style.top = `${top}px`;
                        // 左端揃え、ただし右にはみ出る場合は右寄せ
                        let left = rect.left;
                        if (left + 250 > window.innerWidth - 20) {
                            left = window.innerWidth - 270;
                        }
                        popup.style.left = `${left}px`;

                        // 高さを再計算して表示
                        popup.style.display = 'block';

                        // 表示後に高さが確定するので、再度位置調整が必要な場合に対応
                        const finalHeight = popup.offsetHeight;
                        if (rect.bottom + 5 + finalHeight > windowHeight - 20) {
                            popup.style.top = `${rect.top - finalHeight - 5}px`;
                        }

                        // ポップアップ自体のホバー設定
                        popup.onmouseenter = function () {
                            if (window.popupHideTimeout) clearTimeout(window.popupHideTimeout);
                        };
                        popup.onmouseleave = function () {
                            window.popupHideTimeout = setTimeout(() => {
                                popup.style.display = 'none';
                            }, 300);
                        };
                    });

                    // ホバー解除：ポップアップ非表示（遅延）
                    overflowSpan.addEventListener('mouseleave', function () {
                        window.popupHideTimeout = setTimeout(() => {
                            const popup = document.getElementById('hoverPopup');
                            popup.style.display = 'none';
                        }, 300);
                    });

                    // クリックで全件表示（トグル動作）
                    overflowSpan.onclick = function (e) {
                        e.stopPropagation();
                        // 隠れている投稿を追加表示
                        hiddenGroups.forEach(group => {
                            const postCard = createGroupedPostCard(group);
                            postCard.classList.add('hidden-item'); // クラス付与（識別用）
                            postsContainer.appendChild(postCard);
                        });

                        // +X件を非表示にし、代わりに閉じるボタンを表示
                        overflowDiv.style.display = 'none';
                        contentDiv.style.overflow = 'auto'; // スクロール可能に

                        // 閉じるボタンを作成
                        const closeDiv = document.createElement('div');
                        closeDiv.className = 'text-center py-1 sticky bottom-0 bg-white/90 cursor-pointer border-t border-gray-100 mt-1';
                        closeDiv.innerHTML = '<span class="text-[9px] text-gray-400 hover:text-gray-600">▲ 閉じる</span>';

                        closeDiv.onclick = function (ev) {
                            ev.stopPropagation();
                            // 追加したアイテムを削除
                            const hiddenItems = postsContainer.querySelectorAll('.hidden-item');
                            hiddenItems.forEach(item => item.remove());

                            // 状態を元に戻す
                            closeDiv.remove();
                            overflowDiv.style.display = 'block';
                            contentDiv.style.overflow = 'hidden';
                            contentDiv.scrollTop = 0;
                        };

                        contentDiv.appendChild(closeDiv);
                    };

                    overflowDiv.appendChild(overflowSpan);
                    contentDiv.appendChild(overflowDiv);
                }

                cell.appendChild(contentDiv);
            }

            return cell;
        }

        // 作品名＋タイトルでグループ化
        function groupPostsByWorkName(posts) {
            const groups = {};

            posts.forEach(post => {
                // グループキー: 作品名＋タイトルの組み合わせ
                const key = `${post.workName || ''}|||${post.title || ''}`;

                if (!groups[key]) {
                    groups[key] = {
                        workName: post.workName,
                        title: post.title,
                        brand: post.brand,
                        time: post.time,
                        description: post.description,
                        platforms: [],
                        posts: []
                    };
                }

                groups[key].platforms.push(post.platform);
                groups[key].posts.push(post);

                // 時間が設定されている投稿を優先
                if (post.time && !groups[key].time) {
                    groups[key].time = post.time;
                }
            });

            const result = Object.values(groups);

            // 媒体の優先順位（TT > IGリール > IGフィード > IGストーリー）
            const priorityMap = { 'TikTok': 1, 'IGリール': 2, 'IGフィード': 3, 'IGストーリー': 4 };

            // 優先順位に基づいてソート
            result.sort((a, b) => {
                // 各グループ内で最も優先度が高い媒体を取得して比較
                const getMinPriority = (group) => {
                    let min = 99;
                    group.platforms.forEach(p => {
                        const pVal = priorityMap[p] || 99;
                        if (pVal < min) min = pVal;
                    });
                    return min;
                };

                return getMinPriority(a) - getMinPriority(b);
            });

            return result;
        }

        // グループ化された投稿カードを作成
        function createGroupedPostCard(group) {
            const card = document.createElement('div');
            // パディングを p-2 -> p-1 に削減
            card.className = 'post-card p-1 bg-white border border-gray-200 rounded-lg shadow-sm cursor-pointer border-l-2 border-l-indigo-400';

            // ツールチップに全詳細を表示
            const tooltipLines = group.posts.map(p => `${p.platform}: ${p.title}`);
            card.title = `${group.workName || ''}\n${tooltipLines.join('\n')}\n${group.description || ''}`;

            // ブランドと時間のヘッダー
            if (group.brand || group.time) {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex items-center gap-1 mb-0.5 text-[8px] text-gray-400';
                headerDiv.innerHTML = `${group.brand ? `<span class="font-medium truncate">${group.brand}</span>` : ''}${group.time ? `<span class="ml-auto">${group.time}</span>` : ''}`;
                card.appendChild(headerDiv);
            }

            // 作品名を表示
            if (group.workName) {
                const workNameDiv = document.createElement('div');
                workNameDiv.className = 'text-[9px] font-bold text-gray-700 truncate leading-tight';
                workNameDiv.textContent = group.workName;
                card.appendChild(workNameDiv);
            }

            // タイトル（投稿名）を表示
            if (group.title) {
                const titleDiv = document.createElement('div');
                titleDiv.className = 'text-[8px] text-gray-500 truncate mb-0.5 leading-tight';
                titleDiv.textContent = group.title;
                card.appendChild(titleDiv);
            }

            // プラットフォームを略語で表示
            const platformsDiv = document.createElement('div');
            platformsDiv.className = 'flex items-center gap-1 flex-wrap';

            // 略語マッピング
            const platformAbbr = {
                'IGリール': 'IGR',
                'IGストーリー': 'IGS',
                'IGフィード': 'IGF',
                'TikTok': 'TT'
            };

            // 重複を除いたプラットフォームリスト
            const uniquePlatforms = [...new Set(group.platforms)];

            // ソート（優先順位マップを使用）
            const priorityMap = { 'TikTok': 1, 'IGリール': 2, 'IGフィード': 3, 'IGストーリー': 4 };
            uniquePlatforms.sort((a, b) => (priorityMap[a] || 99) - (priorityMap[b] || 99));

            uniquePlatforms.forEach(platform => {
                const abbr = platformAbbr[platform] || platform;
                const isIG = platform.startsWith('IG');
                const count = group.platforms.filter(p => p === platform).length;

                const abbrSpan = document.createElement('span');
                abbrSpan.className = `inline-flex items-center justify-center px-1.5 py-0.5 rounded text-[9px] font-bold ${isIG ? 'bg-pink-100 text-pink-600' : 'bg-gray-800 text-white'}`;
                abbrSpan.textContent = count > 1 ? `${abbr}×${count}` : abbr;
                platformsDiv.appendChild(abbrSpan);
            });

            card.appendChild(platformsDiv);

            return card;
        }



        // 作品名ドロップダウンを更新
        function updateWorkNameFilter() {
            const select = document.getElementById('workNameFilter');
            const workNames = [...new Set(calendarData.map(post => post.workName).filter(name => name))];
            workNames.sort();

            select.innerHTML = '<option value="all">すべて</option>';
            workNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        // 作品名フィルター
        function filterWorkName(workName) {
            currentWorkNameFilter = workName;
            renderCalendar();
        }

        // 月を変更
        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        // 今月に戻る
        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }

        // カレンダー形式のデータを生成（現在表示中の月）
        function generateCalendarTable() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            const rows = [];
            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];

            // ヘッダー行
            rows.push(dayNames);

            let week = [];

            // 前月の空白セル
            for (let i = 0; i < startDay; i++) {
                week.push('');
            }

            // 当月の日付
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDay = new Date(year, month, day);
                const posts = getPostsForDate(currentDay);

                // セルの内容を作成
                let cellContent = day.toString();
                if (posts.length > 0) {
                    const postTexts = posts.map(p => {
                        const parts = [];
                        if (p.workName) parts.push(`[${p.workName}]`);
                        if (p.time) parts.push(p.time);
                        parts.push(p.platform);
                        if (p.title) parts.push(p.title);
                        return parts.join(' ');
                    });
                    cellContent = day + '\n' + postTexts.join('\n');
                }

                week.push(cellContent);

                // 週の終わり（土曜日）または月末
                if (week.length === 7) {
                    rows.push([...week]);
                    week = [];
                }
            }

            // 残りの空白セル
            if (week.length > 0) {
                while (week.length < 7) {
                    week.push('');
                }
                rows.push(week);
            }

            return rows;
        }

        // クリップボードにコピー（スプレッドシート用タブ区切り）
        function copyCalendarToClipboard() {
            if (calendarData.length === 0) {
                alert('まずExcelファイルをアップロードしてください');
                return;
            }

            const rows = generateCalendarTable();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;

            // タイトル行を追加
            const title = `${year}年${month}月 投稿カレンダー`;
            const tsv = title + '\n\n' + rows.map(row => row.join('\t')).join('\n');

            navigator.clipboard.writeText(tsv).then(() => {
                const status = document.getElementById('fileStatus');
                status.textContent = 'カレンダーをコピーしました！';
                status.className = 'text-sm text-green-500';
                setTimeout(() => {
                    status.textContent = '';
                }, 3000);
            }).catch(err => {
                alert('コピーに失敗しました: ' + err);
            });
        }

        // CSVダウンロード
        function downloadCalendarCSV() {
            if (calendarData.length === 0) {
                alert('まずExcelファイルをアップロードしてください');
                return;
            }

            const rows = generateCalendarTable();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;

            // CSVを生成（セル内改行を扱うため、ダブルクォートで囲む）
            const csv = rows.map(row =>
                row.map(cell => {
                    if (cell.includes('\n') || cell.includes(',') || cell.includes('"')) {
                        return '"' + cell.replace(/"/g, '""') + '"';
                    }
                    return cell;
                }).join(',')
            ).join('\n');

            // BOM付きUTF-8でダウンロード
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `calendar_${year}_${month}.csv`;
            a.click();

            URL.revokeObjectURL(url);

            const status = document.getElementById('fileStatus');
            status.textContent = 'CSVをダウンロードしました！';
            status.className = 'text-sm text-green-500';
            setTimeout(() => {
                status.textContent = '';
            }, 3000);
        }

        // データの保存（localStorage）
        function saveCalendarData(data) {
            try {
                // 日付オブジェクトなどはJSON化で文字列になるので注意
                localStorage.setItem('sns_calendar_data', JSON.stringify(data));
                localStorage.setItem('sns_calendar_updated', new Date().toLocaleString());
            } catch (e) {
                console.error('保存エラー:', e);
                // 容量オーバーなどの場合
                alert('データ量が多すぎるため、ブラウザに自動保存できませんでした。\n(表示自体は可能ですが、リロードするとリセットされます)');
            }
        }

        // データの読み込み（localStorage）
        function loadCalendarData() {
            const saved = localStorage.getItem('sns_calendar_data');
            const savedTime = localStorage.getItem('sns_calendar_updated');

            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // 日付文字列をDateオブジェクトに復元
                    calendarData = parsed.map(item => ({
                        ...item,
                        date: new Date(item.date)
                    }));

                    if (calendarData.length > 0) {
                        // 読み込み成功したら描画だけする（アラートは出さない）
                        renderCalendar();
                        updateWorkNameFilter();

                        const fileStatus = document.getElementById('fileStatus');
                        fileStatus.textContent = `前回保存データ: ${calendarData.length}件 (${savedTime})`;
                        fileStatus.className = 'text-sm text-gray-500';
                    }
                } catch (e) {
                    console.error('読み込みエラー:', e);
                    localStorage.removeItem('sns_calendar_data'); // 壊れたデータは削除
                }
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function () {
            renderCalendar(); // まず空のカレンダーを描画
            loadCalendarData(); // 保存データがあれば上書き描画
        });
    </script>
    <!-- ホバーポップアップ -->
    <div id="hoverPopup" class="hover-popup space-y-1"></div>
</body>

</html>